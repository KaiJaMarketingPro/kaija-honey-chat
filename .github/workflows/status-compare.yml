name: ğŸ§ª Status Summary Integrity Check

on:
  push:
    paths:
      - 'api/config/status-summary.json'
      - '.github/workflows/status-compare.yml'
  schedule:
    - cron: '0 6 * * *'  # tÃ¤glich um 06:00 Uhr CET

jobs:
  diff-status-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: âœ¨ Vergleiche status-summary.json â€“ Prod vs Last Commit

    steps:
      - name: âœ… Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # fÃ¼r diff-Vergleich

      - name: â­ Setup Node.js (fÃ¼r Script & JSON)
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ” Lade Production status-summary von Vercel
        run: |
          PROD_URL="https://honey-chat-v1-${{ secrets.VERCEL_DEPLOYMENT_ID }}.vercel.app/api/config/status-summary.json"
          curl --fail --retry 3 --silent "$PROD_URL" -o prod-status.json
        env:
          VERCEL_DEPLOYMENT_ID: ${{ secrets.VERCEL_DEPLOYMENT_ID }}

      - name: ğŸ”„ Vergleiche mit neuem Commit
        run: |
          git diff --no-index prod-status.json api/config/status-summary.json || true

      - name: ğŸ“Š Diff-Resultat ausgeben
        run: |
          if diff prod-status.json api/config/status-summary.json > diff.txt; then
            echo "âœ… Beide Dateien sind identisch."
          else
            echo "âŒ Unterschiede gefunden zwischen Production und Commit!"
            cat diff.txt
            exit 1
          fi

      - name: ğŸ›  VollstÃ¤ndiger Deployment-Scan (Brutal Truth Check)
        run: |
          echo "ğŸ”¬ Inspect Deployment-Relevante Dateien:"
          find .github/workflows deployment.json api public package.json .vercel -maxdepth 1 -type f

      - name: ğŸ§© Abschluss-Log
        run: |
          echo "Job abgeschlossen am $(date)"
